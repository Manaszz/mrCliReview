# Руководство по системе промптов

## Обзор

Система промптов предоставляет структурированные инструкции для CLI агентов (Cline и Qwen Code) для выполнения code review. Промпты экстернализованы, находятся под контролем версий и поддерживают подстановку переменных для гибкости.

---

## Структура директорий

```
prompts/
├── cline/                      # Промпты для Cline CLI (DeepSeek V3.1)
│   ├── error_detection.md
│   ├── best_practices.md
│   ├── refactoring.md
│   ├── security_audit.md
│   └── documentation.md
├── qwen/                       # Промпты для Qwen Code CLI
│   ├── error_detection.md
│   ├── best_practices.md
│   └── refactoring.md
├── additional/                 # Промпты для специализированных типов ревью
│   ├── performance.md
│   ├── architecture.md
│   ├── transaction_management.md
│   ├── concurrency.md
│   └── database_optimization.md
└── todo/                       # Промпты для будущих TODO функций
    ├── jira_task_matcher.md
    └── changelog_generator.md
```

---

## Структура промпта

Каждый файл промпта следует этой структуре:

```markdown
# Промпт [Тип ревью] для [CLI Агент]

## Цель
Чёткое определение того, что промпт стремится достичь.

## Контекст
Переменные, которые будут подставлены:
- **Путь к репозиторию**: {repo_path}
- **Язык**: {language}
- **Изменённые файлы**: {changed_files}
- **Пользовательские правила**: {custom_rules}
- **JIRA контекст**: {jira_context}

## Scope анализа
Детальные инструкции о том, что анализировать и как.

### Категория 1
Конкретные паттерны для обнаружения с примерами.

### Категория 2
Больше паттернов...

## Формат вывода
JSON структура, ожидаемая от CLI агента.

## Инструкции
Пошаговые инструкции для CLI агента.
```

---

## Подстановка переменных

### Доступные переменные

| Переменная | Описание | Пример |
|-----------|----------|---------|
| `{repo_path}` | Локальный путь к клонированному репозиторию | `/tmp/review/project-123-mr-456` |
| `{language}` | Язык программирования | `java` |
| `{changed_files}` | Список файлов, изменённых в MR | `["src/main/java/User.java", ...]` |
| `{custom_rules}` | Загруженное содержимое пользовательских правил | Содержимое `.project-rules/` или Confluence |
| `{jira_context}` | Описание и контекст JIRA задачи | Описание задачи, критерии приёмки |
| `{review_types}` | Выбранные типы ревью | `["ERROR_DETECTION", "SECURITY_AUDIT"]` |

### Процесс подстановки

1. **Загрузить промпт**: Прочитать файл промпта из `prompts/{agent}/{review_type}.md`
2. **Собрать контекст**: Собрать значения переменных из запроса и окружения
3. **Подставить**: Заменить placeholder'ы `{variable}` на фактические значения
4. **Отправить CLI**: Передать обработанный промпт CLI агенту

### Пример подстановки

**Оригинальный промпт**:
```markdown
## Контекст
- **Путь к репозиторию**: {repo_path}
- **Изменённые файлы**: {changed_files}
```

**После подстановки**:
```markdown
## Контекст
- **Путь к репозиторию**: /tmp/review/project-123-mr-456
- **Изменённые файлы**: ["src/main/java/UserService.java", "src/main/java/OrderService.java"]
```

---

## Типы промптов

### 1. Основные промпты (Cline)

#### error_detection.md
**Назначение**: Идентифицировать баги и потенциальные падения  
**Ключевые проверки**:
- Риски NullPointerException
- Проблемы обработки исключений
- Утечки ресурсов
- Нарушения типобезопасности

**Вывод**: JSON с проблемами, серьёзностью и предложениями

---

#### best_practices.md
**Назначение**: Применять SOLID, конвенции Spring, современный Java  
**Ключевые проверки**:
- Нарушения принципов SOLID
- Spring Boot анти-паттерны
- Нарушения DRY
- Соответствие KISS
- Возможности современных Java функций

**Вывод**: JSON с нарушениями лучших практик и предложениями по рефакторингу

---

#### refactoring.md
**Назначение**: Предлагать улучшения кода для поддерживаемости  
**Ключевые проверки**:
- Циклические зависимости
- Бизнес-логика в контроллерах
- Code smells (длинные методы, глубокая вложенность)
- Сложные boolean выражения

**Вывод**: JSON с предложениями по рефакторингу, классифицированными как SIGNIFICANT или MINOR

---

#### security_audit.md
**Назначение**: Идентифицировать уязвимости безопасности  
**Ключевые проверки**:
- SQL injection
- XSS
- CSRF
- Проблемы аутентификации/авторизации
- Захардкоженные credentials
- Слабая криптография

**Вывод**: JSON с уязвимостями, серьёзностью, CWE ссылками, сценариями атак

---

#### documentation.md
**Назначение**: Генерировать JavaDoc и комментарии к коду  
**Ключевые проверки**:
- Отсутствующий JavaDoc на публичных API
- Неполная документация методов
- Сложная логика, требующая комментариев

**Вывод**: JSON с сгенерированной документацией + git commit в source branch

---

### 2. Специализированные промпты (Additional)

#### performance.md
**Назначение**: Идентифицировать проблемы производительности  
**Фокус**: N+1 запросы, кэширование, оптимизация потоков, connection pooling

#### architecture.md
**Назначение**: Проверять архитектурные паттерны  
**Фокус**: Circuit breakers, дизайн API, паттерны микросервисов, DTO

#### transaction_management.md
**Назначение**: Проверять использование @Transactional  
**Фокус**: Размещение, propagation, уровни изоляции

#### concurrency.md
**Назначение**: Идентифицировать проблемы конкурентности  
**Фокус**: Race conditions, потокобезопасность, использование @Async

#### database_optimization.md
**Назначение**: Оптимизировать запросы к БД  
**Фокус**: Оптимизация запросов, lazy/eager loading, batch операции

---

### 3. Упрощённые промпты (Qwen)

Qwen Code CLI использует упрощённые версии основных промптов:
- Сфокусированы на ключевых паттернах
- Менее многословные инструкции
- Более быстрое выполнение

---

### 4. TODO промпты (Будущие функции)

#### jira_task_matcher.md
**Назначение**: Проверять, что MR реализует требования JIRA задачи  
**Статус**: TODO - требуется интеграция JIRA API

#### changelog_generator.md
**Назначение**: Генерировать записи CHANGELOG.md  
**Статус**: TODO - требуется парсинг git log

---

## Кастомизация промптов

### Промпты конкретного проекта

Создайте пользовательские промпты в директории `.project-prompts/` (ещё не реализовано, будущая функция):

```
your-project/
├── .project-prompts/
│   ├── error_detection.md      # Переопределить по умолчанию
│   └── custom_security.md      # Дополнительный промпт
├── src/
└── pom.xml
```

### Модификация промптов по умолчанию

1. **Клонировать репозиторий**: Получить репозиторий review service
2. **Редактировать промпт**: Изменить файл в директории `prompts/`
3. **Тестировать**: Запустить ревью на примерном MR
4. **Развернуть**: Пересобрать Docker image или обновить смонтированный volume

---

## Лучшие практики промптов

### 1. Будьте конкретны
❌ **Плохо**: "Проверьте на ошибки"  
✅ **Хорошо**: "Проверьте риски NullPointerException, где методы вызываются на потенциально null объектах без null проверок"

### 2. Предоставляйте примеры
Всегда включайте:
- ПЛОХОЙ пример (анти-паттерн)
- ХОРОШИЙ пример (правильный паттерн)
- Объяснение почему

### 3. Структурированный вывод
Определите точную JSON структуру:
```json
{
  "review_type": "ERROR_DETECTION",
  "issues": [...],
  "summary": {...}
}
```

### 4. Действенные предложения
Каждая проблема должна включать:
- Что не так
- Почему это не так
- Как это исправить
- Пример кода исправления

### 5. Контекстно-зависимые
Используйте переменные для предоставления контекста:
- `{custom_rules}` для стандартов, специфичных для проекта
- `{jira_context}` для понимания намерений
- `{changed_files}` для фокусировки scope

---

## Интеграция с правилами

Промпты ссылаются на правила из `rules/java-spring-boot/`:

```markdown
## Scope анализа
Выполните проверки согласно правилам, определённым в {custom_rules}.

### 1. Предотвращение NullPointerException
Обратитесь к rules/java-spring-boot/error_detection.md Правило 1 для паттернов.
```

Правила предоставляют:
- Детальные примеры паттернов
- Уровни серьёзности
- Возможность автоисправления

Промпты предоставляют:
- Инструкции для CLI агента
- Формат вывода
- Рабочий процесс обработки

---

## Устранение неполадок

### Проблема: CLI агент не следует промпту

**Возможные причины**:
1. Промпт слишком расплывчатый или двусмысленный
2. JSON формат вывода не чётко указан
3. Слишком много инструкций (информационная перегрузка)

**Решения**:
1. Сделайте инструкции более конкретными и действенными
2. Предоставьте точную JSON схему с примерами
3. Разбейте сложные промпты на сфокусированные секции

---

### Проблема: Переменная не подставлена

**Проверьте**:
1. Имя переменной совпадает точно (регистрозависимое)
2. Значение переменной предоставлено в ReviewRequest
3. ReviewService правильно заполняет переменную

**Дебаг**:
```python
# В ReviewService
processed_prompt = self.substitute_variables(prompt, {
    'repo_path': repo_path,
    'language': language,
    'changed_files': json.dumps(changed_files),
    'custom_rules': custom_rules_content
})
print(f"Processed prompt: {processed_prompt[:500]}")
```

---

### Проблема: Непостоянные результаты

**Возможные причины**:
1. Промпт слишком открытый (допускает интерпретацию)
2. Примеры не исчерпывающие
3. Формат вывода не строго определён

**Решения**:
1. Добавьте более конкретные инструкции
2. Предоставьте примеры для граничных случаев
3. Используйте валидацию JSON схемы

---

## Соображения производительности

### Длина промпта
- **Cline**: Может обрабатывать более длинные промпты (10K+ токенов)
- **Qwen**: Предпочитайте более короткие, сфокусированные промпты (<5K токенов)

### Overhead подстановки переменных
- Минимальное влияние (<10ms на подстановку)
- Переменные подставляются один раз перед отправкой в CLI

### Кэширование
- Промпты загружаются с диска каждый раз (не кэшируются)
- Рассмотрите кэширование для высокочастотных ревью (будущая оптимизация)

---

## Контроль версий

### Отслеживание изменений
- Все промпты находятся под контролем версий в git
- Используйте осмысленные commit messages при обновлении промптов
- Тегируйте релизы для важных изменений промптов

### Стратегия отката
Если новый промпт вызывает проблемы:
1. Откатите git commit
2. Пересоберите Docker image или обновите volume
3. Перезапустите затронутые ревью

---

## Примеры

### Пример 1: Добавление новой проверки в обнаружение ошибок

**Цель**: Добавить проверку для неправильного использования `@Async` на методах, возвращающих void

**Шаги**:
1. Откройте `prompts/cline/error_detection.md`
2. Добавьте новую секцию:
```markdown
### 8. Тип возвращаемого значения @Async метода

**Проверить**: @Async методы, возвращающие void без правильной обработки ошибок

**Анти-паттерн**:
```java
@Async
public void sendEmail(String to, String subject) {
    // Если выброшено исключение, оно тихо проглатывается!
    emailService.send(to, subject);
}
```

**Правильный паттерн**:
```java
@Async
public CompletableFuture<Void> sendEmail(String to, String subject) {
    return CompletableFuture.runAsync(() -> {
        emailService.send(to, subject);
    });
}
```
```
3. Протестируйте на примерном коде
4. Разверните обновлённый промпт

---

### Пример 2: Создание пользовательского промпта для команды

**Цель**: Добавить проверку безопасности, специфичную для компании

**Шаги**:
1. Создайте `prompts/cline/company_security.md`
2. Определите паттерны, специфичные для компании
3. Обновите ReviewService для загрузки пользовательского промпта
4. Добавьте в enum типов ревью

---

## Будущие улучшения

### Запланированные функции
1. **Шаблоны промптов**: Переиспользуемые компоненты промптов
2. **Динамические промпты**: Адаптация на основе типа проекта
3. **Тестирование промптов**: Автоматизированное тестирование эффективности промптов
4. **Аналитика промптов**: Отслеживание того, какие промпты находят больше проблем
5. **Мультиязычные промпты**: Поддержка Python, JavaScript и т.д.

---

## Ссылки

- [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)
- [Anthropic Claude Prompt Library](https://docs.anthropic.com/claude/prompt-library)
- [Cline CLI Documentation](https://docs.cline.bot)
- [Qwen Code Documentation](https://qwenlm.github.io)

---

**Последнее обновление**: 2025-11-03  
**Версия**: 2.0.0
